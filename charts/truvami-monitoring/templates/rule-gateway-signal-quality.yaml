apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
  name: truvami-gateway-signal-quality
spec:
  groups:
    - name: truvami-gateway-signal-quality
      rules:
        - alert: TruvamiGatewaySignalQualityPoor
          annotations:
            description: >-
              **What's happening:** Gateway {{ "{{" }} $labels.gatewayId }} is receiving poor signal quality from device {{ "{{" }} $labels.devEui }} (RSSI: {{ "{{" }} $value }}dBm).
              
              **Why this occurred:** The `truvami_gateway_uplink_rssi` metric shows signal strength below -120dBm, indicating:
              - Device is at maximum range from gateway
              - Physical obstructions blocking signal path
              - Device antenna orientation issues
              - Device battery affecting transmission power
              - Gateway receiver sensitivity problems
              - Environmental interference
              
              **What to do:**
              1. Check device {{ "{{" }} $labels.devEui }} location relative to gateway {{ "{{" }} $labels.gatewayId }}
              2. Verify device battery status and transmission power
              3. Check for physical obstructions in signal path
              4. Consider device relocation or additional gateway coverage
              5. Monitor device antenna orientation and installation
              6. Verify gateway receiver health and antenna connections
            summary: >-
              Poor signal quality: Gateway {{ "{{" }} $labels.gatewayId }} <- Device {{ "{{" }} $labels.devEui }} ({{ "{{" }} $value }}dBm)
          expr: >-
            truvami_gateway_uplink_rssi < -120
          for: 5m
          labels:
            namespace: {{ .Release.Namespace }}
            severity: minor
            node: "gateway-{{ "{{" }} $labels.gatewayId }}"
            service: truvami-device
            component: signal-quality
            gatewayId: "{{ "{{" }} $labels.gatewayId }}"
            devEui: "{{ "{{" }} $labels.devEui }}"
            {{- with .Values.alertLabels }}
            {{- toYaml . | nindent 12 }}
            {{- end }}

        - alert: TruvamiGatewaySignalQualityCritical
          annotations:
            description: >-
              **What's happening:** Gateway {{ "{{" }} $labels.gatewayId }} is receiving critically poor signal from device {{ "{{" }} $labels.devEui }} (RSSI: {{ "{{" }} $value }}dBm).
              
              **Why this occurred:** Signal strength below -125dBm indicates severe connectivity issues that may result in:
              - Intermittent or lost communications
              - High packet loss and retransmissions
              - Increased device battery drain from higher power attempts
              - Potential complete communication loss
              
              **What to do:**
              1. **URGENT**: Investigate device {{ "{{" }} $labels.devEui }} connectivity immediately
              2. Check if device is moving out of gateway range
              3. Plan device relocation or add gateway coverage
              4. Verify device is still operational and accessible
            summary: >-
              Critical signal quality: Gateway {{ "{{" }} $labels.gatewayId }} <- Device {{ "{{" }} $labels.devEui }} ({{ "{{" }} $value }}dBm)
          expr: >-
            truvami_gateway_uplink_rssi < -125
          for: 2m
          labels:
            namespace: {{ .Release.Namespace }}
            severity: major
            node: "gateway-{{ "{{" }} $labels.gatewayId }}"
            service: truvami-device
            component: signal-quality
            gatewayId: "{{ "{{" }} $labels.gatewayId }}"
            devEui: "{{ "{{" }} $labels.devEui }}"
            {{- with .Values.alertLabels }}
            {{- toYaml . | nindent 12 }}
            {{- end }}

        - alert: TruvamiGatewaySNRLow
          annotations:
            description: >-
              **What's happening:** Gateway {{ "{{" }} $labels.gatewayId }} is receiving low SNR from device {{ "{{" }} $labels.devEui }} (SNR: {{ "{{" }} $value }}dB).
              
              **Why this occurred:** The `truvami_gateway_uplink_snr` metric shows signal-to-noise ratio below -15dB, indicating:
              - High noise environment affecting signal quality
              - Interference from other radio sources
              - Gateway receiver sensitivity issues
              - Device transmission power insufficient for distance
              - Environmental factors affecting signal propagation
              
              **What to do:**
              1. Check for radio interference sources near gateway {{ "{{" }} $labels.gatewayId }}
              2. Verify gateway antenna installation and orientation
              3. Monitor environmental factors affecting signal propagation
              4. Consider increasing device transmission power if possible
              5. Evaluate need for additional gateway coverage
            summary: >-
              Low SNR: Gateway {{ "{{" }} $labels.gatewayId }} <- Device {{ "{{" }} $labels.devEui }} ({{ "{{" }} $value }}dB)
          expr: >-
            truvami_gateway_uplink_snr < -15
          for: 10m
          labels:
            namespace: {{ .Release.Namespace }}
            severity: minor
            node: "gateway-{{ "{{" }} $labels.gatewayId }}"
            service: truvami-device
            component: signal-quality
            gatewayId: "{{ "{{" }} $labels.gatewayId }}"
            devEui: "{{ "{{" }} $labels.devEui }}"
            {{- with .Values.alertLabels }}
            {{- toYaml . | nindent 12 }}
            {{- end }}