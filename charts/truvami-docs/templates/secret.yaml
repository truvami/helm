apiVersion: v1
kind: Secret
metadata:
  name: {{ include "truvami-docs.fullname" . }}
  labels:
    {{- include "truvami-docs.labels" . | nindent 4 }}
type: Opaque
data:
  NODE_ENV: {{ "production" | b64enc }}

  # Better Auth Configuration
  {{- if not .Values.betterAuth.existingSecret }}
  BETTER_AUTH_SECRET: {{- if .Values.betterAuth.secret }}
    {{ .Values.betterAuth.secret | b64enc }}
  {{- else if (lookup "v1" "Secret" .Release.Namespace (include "truvami-docs.fullname" .)) }}
    {{ (lookup "v1" "Secret" .Release.Namespace (include "truvami-docs.fullname" .)).data.BETTER_AUTH_SECRET }}
  {{- else }}
    {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  {{- end }}

  # Application Configuration
  {{- if .Values.app.publicUrl }}
  NEXT_PUBLIC_APP_URL: {{ .Values.app.publicUrl | b64enc }}
  {{- else if .Values.ingress.enabled }}
  {{- with (index .Values.ingress.hosts 0) }}
  NEXT_PUBLIC_APP_URL: {{ printf "https://%s" .host | b64enc }}
  {{- end }}
  {{- else }}
  NEXT_PUBLIC_APP_URL: {{ "http://localhost:3000" | b64enc }}
  {{- end }}

  # Public Client Configuration (for frontend)
  NEXT_PUBLIC_CLIENT_ID: {{ .Values.keycloak.clientId | b64enc }}
  {{- if .Values.keycloak.discoveryUrl }}
  NEXT_PUBLIC_ISSUER: {{ .Values.keycloak.discoveryUrl | replace "/.well-known/openid-configuration" "" | b64enc }}
  {{- end }}

  # Keycloak OAuth Configuration (for backend)
  KEYCLOAK_DISCOVERY_URL: {{ .Values.keycloak.discoveryUrl | b64enc }}
  KEYCLOAK_CLIENT_ID: {{ .Values.keycloak.clientId | b64enc }}
  {{- if not .Values.keycloak.existingSecret }}
  KEYCLOAK_CLIENT_SECRET: {{- if .Values.keycloak.clientSecret }}
    {{ .Values.keycloak.clientSecret | b64enc }}
  {{- else if (lookup "v1" "Secret" .Release.Namespace (include "truvami-docs.fullname" .)) }}
    {{ (lookup "v1" "Secret" .Release.Namespace (include "truvami-docs.fullname" .)).data.KEYCLOAK_CLIENT_SECRET }}
  {{- else }}
    {{ "" | b64enc }}
  {{- end }}
  {{- end }}

  # Database Configuration
  {{- if not .Values.postgres.enabled }}
  {{- if not .Values.database.existingSecret }}
  {{- if .Values.database.url }}
  DATABASE_URL: {{ .Values.database.url | b64enc }}
  {{- else if not .Values.postgres.external.existingSecret }}
  # Database configuration for external PostgreSQL
  DATABASE_URL: {{ printf "postgresql://%s:%s@%s:%g/%s" .Values.postgres.external.username .Values.postgres.external.password .Values.postgres.external.host .Values.postgres.external.port .Values.postgres.external.database | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}
