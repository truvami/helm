name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.filter.outputs.charts }}
      dashboards: ${{ steps.filter.outputs.dashboards }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            charts:
              - 'charts/**'
            dashboards:
              - 'dashboards/**'

  charts-lint:
    name: Helm chart linting (ct)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.16.1'

      - name: Cache Helm repository data
        uses: actions/cache@v5
        with:
          path: ~/.cache/helm
          key: helm-cache-${{ runner.os }}-${{ hashFiles('charts/**/Chart.yaml') }}
          restore-keys: |
            helm-cache-${{ runner.os }}-

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add strimzi https://strimzi.io/charts/
          helm repo update

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --config ct.yaml --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changed charts:"
            echo "$changed"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No charts changed"
          fi

      - name: Run ct lint
        if: steps.list-changed.outputs.changed == 'true'
        run: ct lint --config ct.yaml --target-branch ${{ github.event.repository.default_branch }}

  kubeconform:
    name: Kubeconform schema validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s: ['1.26.0', '1.28.0']
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
          | tar -xz && sudo mv kubeconform /usr/local/bin/

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --config ct.yaml --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            printf '%s\n' "$changed" > changed_charts.txt
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate templates against ${{ matrix.k8s }}
        if: steps.list-changed.outputs.changed == 'true'
        continue-on-error: true
        run: |
          while read -r chart; do
            echo "Validating $chart for Kubernetes ${{ matrix.k8s }}"
            helm template test "$chart" --kube-version ${{ matrix.k8s }} \
            | kubeconform -strict -ignore-missing-schemas -summary
          done < changed_charts.txt

  security-scan:
    name: kube-score security scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install kube-score
        run: |
          KUBE_SCORE_VERSION="1.20.0"
          wget -O kube-score.tar.gz https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/kube-score_${KUBE_SCORE_VERSION}_linux_amd64.tar.gz
          tar -xzf kube-score.tar.gz
          sudo mv kube-score /usr/local/bin/
          kube-score version

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --config ct.yaml --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            printf '%s\n' "$changed" > changed_charts.txt
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run kube-score on changed charts
        if: steps.list-changed.outputs.changed == 'true'
        continue-on-error: true
        run: |
          while read -r chart; do
            echo "Running kube-score for $chart"
            helm template "$chart" | kube-score score - --output-format ci
          done < changed_charts.txt

  documentation:
    name: Chart docs up-to-date
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install helm-docs
        run: |
          cd /tmp
          HELM_DOCS_VERSION="1.14.2"
          wget https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar -xzf helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          sudo mv helm-docs /usr/local/bin/
          helm-docs --version

      - name: Generate documentation
        run: |
          for chart in $(ls ./charts); do
            helm-docs --chart-search-root ./charts/$chart
          done

      - name: Detect changes
        id: docs_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "dirty=true" >> "$GITHUB_OUTPUT"
          else
            echo "dirty=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto-commit updated docs (same-repo PRs)
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          steps.docs_changes.outputs.dirty == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs(charts): update generated READMEs"
          file_pattern: charts/**/README.md

      - name: Fail if docs are outdated (fork PRs or pushes)
        if: steps.docs_changes.outputs.dirty == 'true' && ! (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          echo "‚ùå Documentation is out of date. Please run 'helm-docs' and commit the changes."
          git status --porcelain
          exit 1

  dashboards:
    name: Dashboards build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.dashboards == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go (for Jsonnet tools)
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true

      - name: Install Jsonnet tools
        run: |
          go install github.com/google/go-jsonnet/cmd/jsonnet@latest
          go install github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb@latest

      - name: Cache Jsonnet dependencies
        uses: actions/cache@v5
        with:
          path: dashboards/vendor
          key: jsonnet-deps-${{ hashFiles('dashboards/jsonnetfile.lock.json') }}
          restore-keys: |
            jsonnet-deps-

      - name: Build dashboards
        run: make build-dashboards

  chart-diagrams:
    name: Generate chart diagrams
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.16.1'

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --config ct.yaml --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            printf '%s\n' "$changed" > changed_charts.txt
            echo "Changed charts:"
            cat changed_charts.txt
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate diagrams
        # if: steps.list-changed.outputs.changed == 'true'
        run: |
          mkdir -p diagrams
          while read -r chart; do
            chart_name=$(basename "$chart")
            echo "Processing $chart_name"

            # Update dependencies for charts that need them
            if [[ "$chart_name" == "truvami-stack" ]]; then
              helm dependency update "$chart" || echo "Failed to update dependencies for $chart_name"
            fi

            # Generate current diagram
            helm template "$chart" > /tmp/${chart_name}.yaml || echo "Failed to template $chart_name"
            docker run --rm -v /tmp:/tmp -v $(pwd)/diagrams:/diagrams philippemerle/kubediagrams kube-diagrams \
              -o /diagrams/${chart_name}.png \
              /tmp/${chart_name}.yaml || echo "Failed to generate diagram for $chart_name"

            # Check if diagram exists on base branch and fetch it for comparison
            if git show origin/${{ github.event.repository.default_branch }}:diagrams/${chart_name}.png > /tmp/${chart_name}.previous.png 2>/dev/null; then
              echo "Found previous diagram for $chart_name, copying to diagrams folder"
              cp /tmp/${chart_name}.previous.png diagrams/${chart_name}.previous.png
            else
              echo "No previous diagram found for $chart_name on base branch"
            fi
          done < changed_charts.txt

      - name: Commit diagrams
        # if: steps.list-changed.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add diagrams/ || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: add chart diagrams for PR review"
            git push origin HEAD:${{ github.head_ref }}
            echo "Diagrams committed and pushed successfully"
          fi

      - name: Upload diagram artifacts
        # if: steps.list-changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: chart-diagrams
          path: diagrams

      - name: Create comparison comment
        # if: steps.list-changed.outputs.changed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const charts = fs.readFileSync('changed_charts.txt', 'utf8').trim().split('\n');

            let comment = '## üìä Chart Diagram\n\n';
            comment += 'Visual representation of Kubernetes resources in changed charts:\n\n';

            const repoUrl = `https://raw.githubusercontent.com/${{ github.repository }}/${{ github.head_ref }}/diagrams`;

            for (const chart of charts) {
              const chartName = path.basename(chart);
              const currentPath = `diagrams/${chartName}.png`;
              const previousPath = `diagrams/${chartName}.previous.png`;
              const currentExists = fs.existsSync(currentPath);
              const previousExists = fs.existsSync(previousPath);

              if (previousExists && currentExists) {
                comment += `<details>\n<summary><strong>${chartName}</strong> (Before/After)</summary>\n\n`;
                comment += '| Before | After |\n';
                comment += '|--------|-------|\n';
                const beforeImg = `<img src="${repoUrl}/${chartName}.previous.png" width="500" alt="Before" />`;
                const afterImg = `<img src="${repoUrl}/${chartName}.png" width="500" alt="After" />`;
                comment += `| ${beforeImg} | ${afterImg} |\n\n`;
                comment += `</details>\n\n`;
              } else if (currentExists) {
                comment += `<details>\n<summary><strong>${chartName}</strong> (New/Updated)</summary>\n\n`;
                comment += `<img src="${repoUrl}/${chartName}.png" width="800" alt="Diagram" />\n\n`;
                comment += `</details>\n\n`;
              } else {
                comment += `<details>\n<summary><strong>${chartName}</strong></summary>\n\n`;
                comment += '‚ùå Failed to generate diagram\n\n';
                comment += `</details>\n\n`;
              }
            }

            comment += '\n> üí° Diagrams generated with [KubeDiagrams](https://github.com/philippemerle/KubeDiagrams)\n';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üìä Chart Diagram')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
